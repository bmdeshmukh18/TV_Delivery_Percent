name: Run Python Script to create stock CSVs

on:
  workflow_dispatch:
  schedule:
    # Example: run daily at 7 PM IST
    - cron: '30 13 * * *'   # 13:30 UTC = 19:00 IST

permissions:
  contents: write   # allow pushing commits

jobs:
  run-secondary-script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0   # full history so we can pull/rebase

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run secondary script
        run: python bulkToStockCSV.py

      - name: Commit and push generated directories/files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add the new directories and files created by the script
          git add -A

          # Commit only if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Add/update generated data - $(date +%Y-%m-%d)"

            # Pull latest changes to avoid push rejection
            git pull --rebase origin main

            # Push to main branch
            git push origin main
          else
            echo "No changes to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
